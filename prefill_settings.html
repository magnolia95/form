<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预输入规则设置 (云同步)</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; }
        h1, h2 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .container { background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; }
        textarea { width: 100%; min-height: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #rulesList table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #rulesList th, #rulesList td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #rulesList .delete-btn { background-color: #f44336; padding: 5px 10px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>预输入规则设置 (云同步)</h1>
    <div class="container">
        <h2>从 Excel 批量导入</h2>
        <p>从电子表格复制三列（姓名, 媒体机构, 国家/地区），粘贴到下方。**每次导入都会覆盖所有旧规则。**</p>
        <textarea id="bulkData" placeholder="例如:&#10;liu	CGTN	China&#10;wang	Xinhua	China"></textarea>
        <button id="importBtn" onclick="importRules()">导入并覆盖所有云端规则</button>
    </div>

    <h2>当前云端规则列表</h2>
    <div id="rulesList"><p>正在从云端加载规则...</p></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNCZUg5wtiWdlrd0AqnJgJtEo9YdtVPmqxhvITsWmNDwaSO4Qc0NXE-YHIyf-8HFIr/exec";
        let currentRules = [];

        // 从云端加载规则
        function loadRules() {
            const rulesListDiv = document.getElementById('rulesList');
            rulesListDiv.innerHTML = '<p>正在从云端加载规则...</p>';
            fetch(SCRIPT_URL + '?type=rules')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    currentRules = data.map(item => ({
                        triggerName: item.TriggerName,
                        media: item.Media,
                        country: item.Country
                    }));
                    renderRulesTable();
                })
                .catch(error => {
                    console.error('Error loading rules:', error);
                    rulesListDiv.innerHTML = '<p style="color:red;">加载规则失败，请检查脚本URL或网络连接。</p>';
                });
        }
        
        // 渲染规则表格
        function renderRulesTable() {
            const rulesListDiv = document.getElementById('rulesList');
            if (currentRules.length === 0) {
                rulesListDiv.innerHTML = '<p>云端尚未设置任何规则。</p>';
                return;
            }
            let tableHTML = `<table><tr><th>姓名 (触发词)</th><th>媒体机构</th><th>国家/地区</th><th>操作</th></tr>`;
            currentRules.forEach((rule, index) => {
                tableHTML += `<tr><td>${rule.triggerName}</td><td>${rule.media}</td><td>${rule.country}</td><td><button class="delete-btn" onclick="deleteRule(${index})">删除</button></td></tr>`;
            });
            tableHTML += '</table>';
            rulesListDiv.innerHTML = tableHTML;
        }

        // 导入并保存规则到云端
        function importRules() {
            const bulkText = document.getElementById('bulkData').value.trim();
            if (!bulkText) {
                alert('请粘贴要导入的数据。');
                return;
            }
            const lines = bulkText.split('\n');
            const newRules = [];
            lines.forEach(line => {
                const columns = line.split('\t');
                if (columns.length === 3) {
                    const [triggerName, media, country] = columns.map(item => item.trim());
                    if (triggerName && media && country) {
                        newRules.push({ triggerName, media, country });
                    }
                }
            });

            if (newRules.length === 0) {
                alert('未能解析任何有效规则。请确保格式正确（三列，以Tab分隔）。');
                return;
            }
            saveRulesToCloud(newRules);
        }
        
        // 删除规则
        function deleteRule(index) {
            if (confirm('确定要从云端删除这条规则吗？')) {
                currentRules.splice(index, 1);
                saveRulesToCloud(currentRules);
            }
        }

        // 将规则数组保存到云端的通用函数
        function saveRulesToCloud(rulesToSave) {
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.textContent = '正在保存...';

            const payload = {
                action: 'saveRules',
                rules: rulesToSave
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                alert('规则已成功保存到云端！');
                document.getElementById('bulkData').value = '';
                loadRules(); // 重新加载以确认
            })
            .catch(error => {
                console.error('Error saving rules:', error);
                alert('保存规则失败，请稍后重试。');
            })
            .finally(() => {
                importBtn.disabled = false;
                importBtn.textContent = '导入并覆盖所有云端规则';
            });
        }
        
        window.onload = loadRules;
    </script>
</body>
</html>