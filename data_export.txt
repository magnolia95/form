<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导出收集数据</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #45a049; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>媒体嘉宾签到信息</h1>
    <button onclick="exportCSV()">导出为CSV</button>
    <button onclick="clearData()">清除所有数据</button>
    
    <div id="dataTable"><p>正在加载数据...</p></div>
    
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNCZUg5wtiWdlrd0AqnJgJtEo9YdtVPmqxhvITsWmNDwaSO4Qc0NXE-YHIyf-8HFIr/exec";
        let collectedData = [];

        window.onload = function() {
            displayData();
        };
        
        function displayData() {
            const dataDiv = document.getElementById("dataTable");
            dataDiv.innerHTML = "<p>正在加载数据...</p>";

            // 明确指定获取 'data' 类型
            fetch(SCRIPT_URL + '?type=data')
                .then(response => response.json())
                .then(data => {
                    collectedData = data.reverse();
                    if(data.status === 'error'){ throw new Error(data.message); }
                    
                    if (collectedData.length === 0) {
                        dataDiv.innerHTML = "<p>尚未收集到任何数据</p>";
                        return;
                    }
                    
                    let tableHTML = `<table><tr><th>姓名</th><th>电子邮箱</th><th>电话号码</th><th>媒体机构</th><th>国家/地区</th><th>兴趣领域</th><th>提交时间</th></tr>`;
                    collectedData.forEach(entry => {
                        tableHTML += `<tr><td>${entry["姓名"] || "-"}</td><td>${entry["电子邮箱"] || "-"}</td><td>${entry["电话号码"] || "-"}</td><td>${entry["媒体机构"] || "-"}</td><td>${entry["国家/地区"] || "-"}</td><td>${entry["兴趣领域"] || "-"}</td><td>${entry["提交时间"] || "-"}</td></tr>`;
                    });
                    tableHTML += "</table>";
                    dataDiv.innerHTML = tableHTML;
                })
                .catch(error => {
                    console.error("加载数据失败:", error);
                    dataDiv.innerHTML = "<p>加载数据失败，请检查脚本URL或网络连接。</p>";
                });
        }
        
        function exportCSV() {
            if (collectedData.length === 0) { alert("没有数据可导出"); return; }
            let csvContent = "姓名,电子邮箱,电话号码,媒体机构,国家/地区,兴趣领域,提交时间\n";
            collectedData.forEach(entry => {
                const row = [entry["姓名"], entry["电子邮箱"], entry["电话号码"], entry["媒体机构"], entry["国家/地区"], entry["兴趣领域"], entry["提交时间"]].map(v => `"${String(v || "").replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\n";
            });
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "媒体嘉宾签到信息_" + new Date().toISOString().slice(0,10) + ".csv";
            link.click();
        }
        
        function clearData() {
            if (confirm("确定要删除所有收集的数据吗？此操作不可恢复。")) {
                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'clearData' }) })
                    .then(() => { alert("所有数据已清除"); displayData(); })
                    .catch(error => { alert("清除失败，请稍后重试。"); });
            }
        }
    </script>
</body>
</html>